# Merian MCMC Modeling Output File Documentation

This document provides comprehensive documentation for all output files generated by the `merian_mcmc_modeling.py` script, which performs Bayesian MCMC modeling of point sources in Merian emission line data.

## Overview

The Merian MCMC modeling pipeline replaces traditional Moffat fitting with full Bayesian inference using emcee. It processes N540 ([OIII]λ5007) and N708 (Hα) emission line data to detect and characterize point sources while accounting for uncertainties through MCMC sampling.

## Output File Types

The pipeline generates several types of output files for each target and band combination:

### 1. MCMC Results Files (`*_mcmc_results.npz`)

**Format**: NumPy compressed archive (`.npz`)  
**Naming**: `{target}_{band}_mcmc_results.npz`  
**Location**: `{output_dir}/{target}/`

#### Data Contents (from merian_mcmc_modeling.py:686-705):

```python
np.savez(
    output_file,
    chain=chain,                      # MCMC parameter chains
    log_prob=log_prob,               # Log probability values
    acceptance_fraction=sampler.acceptance_fraction,
    max_sources=parameterization.max_sources,
    image_shape=(parameterization.H, parameterization.W),
    mle_n_sources=mle_params['n_sources'],
    mle_x_sources=mle_params['x_sources'],
    mle_y_sources=mle_params['y_sources'], 
    mle_fluxes=mle_params['fluxes'],
    mle_log_prob=mle_params['log_prob'],
    band=band,
    target=target
)
```

#### Column Descriptions:

| Field | Shape | Units | Description |
|-------|-------|-------|-------------|
| `chain` | `(n_steps, n_walkers, n_params)` | various | Full MCMC parameter chains after burn-in |
| `log_prob` | `(n_steps, n_walkers)` | log-likelihood | Log posterior probability for each walker/step |
| `acceptance_fraction` | `(n_walkers,)` | fraction | Acceptance rate for each walker (diagnostic) |
| `max_sources` | scalar | count | Maximum number of sources allowed in model |
| `image_shape` | `(2,)` | pixels | (H, W) dimensions of analyzed image |
| `mle_n_sources` | scalar | count | Number of sources in maximum likelihood solution |
| `mle_x_sources` | `(n_sources,)` | pixels | X-coordinates of MLE sources |
| `mle_y_sources` | `(n_sources,)` | pixels | Y-coordinates of MLE sources |
| `mle_fluxes` | `(n_sources,)` | nJy | Source fluxes from MLE solution |
| `mle_log_prob` | scalar | log-likelihood | Maximum log posterior probability achieved |
| `band` | string | - | Band identifier ('n540' or 'n708') |
| `target` | string | - | Target identifier |

#### Parameter Chain Structure:
The `chain` array contains MCMC samples with parameter layout:
- `params[0]`: Number of sources (discrete, 0 to max_sources)
- `params[1::3]`: X-coordinates of sources (pixels)
- `params[2::3]`: Y-coordinates of sources (pixels)  
- `params[3::3]`: log₁₀(flux) values (log nJy)

### 2. Photometry Catalogs (`*_mcmc_region_photometry.csv`)

**Format**: Comma-separated values (`.csv`)  
**Naming**: `{target}_{band}_mcmc_region_photometry.csv`  
**Location**: `{output_dir}/{target}/`

#### Data Contents (from merian_mcmc_modeling.py:988-1055):

Standard photutils columns plus MCMC-specific additions:

| Column | Units | Description |
|--------|-------|-------------|
| Standard SourceCatalog columns | various | All photutils SourceCatalog measurements |
| `lineflux_corrected` | erg s⁻¹ cm⁻² | Emission line flux with all corrections applied |
| `band` | - | Band identifier ('n540' or 'n708') |
| `target` | - | Target identifier |
| `mcmc_model_lineflux` | erg s⁻¹ cm⁻² | MCMC model-predicted line flux for matched sources |
| `mcmc_model_x` | pixels | X-coordinate from MCMC model (closest match) |
| `mcmc_model_y` | pixels | Y-coordinate from MCMC model (closest match) |
| `mcmc_n_sources` | count | Total number of sources in MCMC model |

#### Special Rows:
- `label = -1`: Integrated flux from total image
- `label = -2`: Integrated broadband flux

### 3. Quality Assessment Images (`*_mcmc_model.png`)

**Format**: PNG image  
**Naming**: `{target}_mcmc_model.png`  
**Location**: `{output_dir}/{target}/`

#### Panel Layout (from merian_mcmc_modeling.py:912-966):
- **Panel (0,0) & (1,0)**: RGB color images with band labels
- **Panel (0,1) & (1,1)**: Excess emission images (data)
- **Panel (0,2) & (1,2)**: MCMC maximum likelihood model
- **Panel (0,3) & (1,3)**: Residuals (data - model)

Rows correspond to N708 (Hα) and N540 ([OIII]) bands respectively.

### 4. Processed Image Arrays (`*_arr.npy`)

**Format**: NumPy binary array (`.npy`)  
**Naming**: `{target}_{band}_arr.npy`  
**Location**: `{output_dir}/{target}/`

Contains the continuum-subtracted excess emission images used as input to MCMC modeling.

## Data Processing and Corrections

### Photometry Method
The pipeline performs aperture photometry using photutils on continuum-subtracted "excess" images:

1. **Continuum Subtraction** (merian_mcmc_modeling.py:784-799):
   - Uses matched PSF photometry 
   - Scales broadband images to subtract continuum
   - Scaling factors from spectral energy distribution fitting

2. **Source Detection** (merian_mcmc_modeling.py:809-854):
   - 5σ detection threshold above background
   - Minimum 5 connected pixels
   - Deblending with 32 levels, 0.001 contrast

3. **MCMC Modeling** (merian_mcmc_modeling.py:863-889):
   - Moffat PSF with α=2.5 (fixed)
   - γ parameter from PSF matching
   - Poisson prior on number of sources (λ=1.5)
   - 128 walkers, 1000 steps, 200 burn-in

### Applied Corrections

All flux measurements include the following corrections (applied in order):

1. **Aperture Correction**: Accounts for flux outside Kron apertures
2. **Galactic Extinction**: A_V correction using Schlegel+1998 dust maps
3. **Host Galaxy Extinction**: Internal extinction from galaxy properties  
4. **Ancillary Line Correction** (N708 only): Accounts for [NII] contamination in Hα filter

#### Correction Details (from merian_mcmc_modeling.py:1095-1096):
```python
emission_corrections = emission.compute_emissioncorrections(catalog, logmstar_key='logmass_gaap1p0')
ancline_correction, ge_correction, extinction_correction, catalog_apercorr = emission_corrections
```

- `extinction_correction[0]`: Galactic extinction factors
- `ge_correction`: Host galaxy extinction factors
- `ancline_correction`: [NII] line contamination correction (N708 band)
- `catalog_apercorr`: Aperture correction factors

### Flux Conversion
Fluxes are converted from nJy to physical units using:
- Conversion factor: `10**(-0.4*(27-31.4))` (merian_mcmc_modeling.py:806)
- Line flux conversion via `emission.excess_to_lineflux()` (merian_mcmc_modeling.py:831)

### PSF Modeling
- **Profile**: Moffat with α=2.5 (fixed across all bands)
- **FWHM Relation**: `FWHM = 2γ√(2^(1/α) - 1)` 
- **Normalization**: Astropy Moffat2D parameterization (merian_mcmc_modeling.py:88-89)

## Target Selection Criteria

Processed targets must meet all criteria (from merian_mcmc_modeling.py:1166-1170):
- Stellar mass: 7.75 < log(M*/M☉) < 9.4
- Aperture correction: < 4× in both i-band and N540
- Emission lines: Hα EW > 5 Å and [OIII] EW > 5 Å  
- Photometric redshift: P(z) > 0.26

## File Organization

```
output_dir/
├── {target1}/
│   ├── {target1}_n540_mcmc_results.npz
│   ├── {target1}_n708_mcmc_results.npz
│   ├── {target1}_n540_mcmc_region_photometry.csv
│   ├── {target1}_n708_mcmc_region_photometry.csv
│   ├── {target1}_mcmc_model.png
│   ├── {target1}_n540_arr.npy
│   └── {target1}_n708_arr.npy
├── {target2}/
│   └── ...
```

## Usage Notes

- MCMC results provide full posterior distributions for source parameters
- MLE parameters give point estimates equivalent to traditional fitting
- Photometry catalogs enable comparison between detection-based and model-based fluxes
- Quality assessment images allow visual inspection of model fits
- All uncertainties properly propagated through Bayesian framework

## Dependencies

- **emcee**: MCMC sampling
- **photutils**: Source detection and photometry  
- **astropy**: Coordinate handling, PSF models, file I/O
- **agrias, carpenter, ekfstats**: Custom analysis libraries
- **numpy, matplotlib**: Numerical computation and visualization

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "1", "content": "Explore merian_mcmc_modeling codebase structure", "status": "completed", "priority": "high"}, {"id": "2", "content": "Identify all output file types and formats", "status": "completed", "priority": "high"}, {"id": "3", "content": "Document photometry methods and corrections", "status": "completed", "priority": "medium"}, {"id": "4", "content": "Create comprehensive output file documentation", "status": "completed", "priority": "high"}]