# FIRE2 Mock Image BYOL Analysis

Script for running BYOL clustering on FIRE2 simulation mock images, where ground truth labels correspond to galaxy initial conditions (e.g., m11b, m11d, m11h).

## Overview

`run_fire2_mock.py` loads randomly projected FIRE2 simulation images and uses BYOL to learn embeddings. It then clusters the embeddings to test whether BYOL can distinguish between different galaxy initial conditions based purely on their morphology.

**Key Concept**: Unlike `run_simulated.py` which generates artificial Sersic profiles, this script uses **real** FIRE2 simulation data with physically-motivated morphologies.

## Workflow

```
1. Load FIRE2 mock images (generated by generate_fire2_images.py)
   - Each galaxy tag (e.g., m11b_res2100) becomes a class
   - N randomly oriented projections per galaxy

2. Preprocess for BYOL
   - Convert 2D histograms → 3-channel "RGB" format
   - Shape: (N, H, W) → (N, 3, H, W)

3. Train BYOL model
   - Self-supervised learning on galaxy morphology
   - No labels used during training

4. Extract embeddings & apply PCA
   - Reduce dimensionality for visualization

5. Cluster embeddings (K-Means)
   - Test if galaxies cluster by initial conditions
   - Align clusters with true labels

6. Evaluate classification performance
   - Purity, completeness, confusion matrix
   - Visualize PCA space colored by true/predicted labels
```

## Prerequisites

### 1. Generate FIRE2 Images First

Before running this script, you must generate mock images for each galaxy:

```bash
cd merger_analysis/scripts

# Generate images for m11b_res2100 (50 projections)
python generate_fire2_images.py \
    --tag m11b_res2100 \
    --n-images 50 \
    --snapshot 600

# Generate images for m11d_res7100 (50 projections)
python generate_fire2_images.py \
    --tag m11d_res7100 \
    --n-images 50 \
    --snapshot 600

# Optional: Generate for additional galaxies
python generate_fire2_images.py --tag m11h_res7100 --n-images 50
```

This creates:
```
merger_analysis/local_data/mock_images/
├── m11b_res2100/
│   ├── image_0000.npy
│   ├── image_0001.npy
│   ├── ...
│   ├── image_0049.npy
│   └── metadata.json
└── m11d_res7100/
    ├── image_0000.npy
    ├── ...
    └── metadata.json
```

### 2. Required Packages

```bash
pip install numpy scipy pyyaml torch scikit-learn matplotlib seaborn
```

## Quick Start

### Basic Usage (2 Galaxies)

```bash
cd merger_analysis/scripts

# Use default: m11b_res2100 and m11d_res7100 with 50 images each
python run_fire2_mock.py
```

### Custom Galaxies (3 Galaxies)

```bash
# Use 3 different galaxies
python run_fire2_mock.py \
    --tags m11b_res2100 m11d_res7100 m11h_res7100 \
    --n-per-galaxy 50
```

### Fast Testing (Fewer Epochs)

```bash
# Quick test with 10 epochs
python run_fire2_mock.py \
    --tags m11b_res2100 m11d_res7100 \
    --n-per-galaxy 20 \
    --epochs 10 \
    --batch-size 64
```

### Custom Output Directory

```bash
python run_fire2_mock.py \
    --output-path ./my_fire2_results \
    --tags m11b_res2100 m11d_res7100
```

## Command-Line Options

```
--config CONFIG                  BYOL config file (default: ../config.yaml)
--tags TAG1 TAG2 ...            Galaxy tags to use (default: m11b_res2100 m11d_res7100)
--n-per-galaxy N                Number of images per galaxy (default: 50)
--mock-images-dir DIR           Location of mock images (default: ../local_data/mock_images)
--random-seed SEED              Random seed for reproducibility (default: 42)
--output-path PATH              Override output directory
--epochs N                      Override training epochs
--batch-size N                  Override batch size
```

## Output Files

The script generates the following outputs in `{output_path}/fire2_mock/`:

### Data Files
- `fire2_mock_data.pkl` - Loaded images, labels, and metadata
- `embeddings.npy` - BYOL embeddings (generated by model manager)
- `dimensionality_reduction_results.pkl` - PCA results and transformed embeddings

### Metrics
- `classification_metrics.json` - Purity, completeness, confusion matrix

### Visualizations
- `sample_fire2_galaxies.png` - QA figure showing sample images from each galaxy
- `evaluation_results.png` - 4-panel figure:
  - Top-left: PCA colored by true labels (galaxy tags)
  - Top-right: PCA colored by predicted labels
  - Bottom-left: Confusion matrix
  - Bottom-right: Metrics summary text

### Model Checkpoints
- `model_checkpoint_epoch_*.pth` - BYOL model weights
- `final_model.pth` - Final trained model

## Understanding the Results

### Ground Truth Labels

Each galaxy tag represents a unique set of initial conditions:
- **m11b_res2100**: Galaxy with specific formation history
- **m11d_res7100**: Different formation history, higher resolution
- **m11h_res7100**: Yet another formation history

All images from the same galaxy are labeled identically, even though they are different random viewing angles.

### Interpretation

**High Purity & Completeness (>0.8)**
- BYOL successfully learned morphological features
- Different galaxies have distinguishable morphologies
- Random projections preserve galaxy-specific features

**Low Purity & Completeness (<0.5)**
- Morphologies are similar across galaxies
- Viewing angle matters more than initial conditions
- May need more images or different preprocessing

### Example Output

```
======================================================================
CLASSIFICATION RESULTS
======================================================================
Overall Purity:       0.8523
Overall Completeness: 0.8412

Per-galaxy metrics:
  m11b_res2100         - Purity: 0.8600, Completeness: 0.8200
  m11d_res7100         - Purity: 0.8446, Completeness: 0.8624

======================================================================
```

This indicates:
- 85% of galaxies in each predicted cluster belong to the correct galaxy
- 84% of galaxies from each true class are assigned to the correct cluster
- BYOL can distinguish m11b from m11d reasonably well

## Comparison with run_simulated.py

| Feature | run_simulated.py | run_fire2_mock.py |
|---------|------------------|-------------------|
| **Input Data** | Artificial Sersic profiles | Real FIRE2 simulations |
| **Ground Truth** | Morphology type (disk/double/dipole) | Galaxy initial conditions (m11b/m11d/etc.) |
| **Image Generation** | On-the-fly during script | Pre-generated by generate_fire2_images.py |
| **Physical Realism** | Simplified models | Full hydrodynamic simulations |
| **Image Channels** | 3 (g, i, hf) | 1 (stellar density) → replicated to 3 |
| **Use Case** | Algorithm testing | Science application |

## Tips for Good Results

### 1. Choose Galaxies Carefully

Pick galaxies with visually distinct morphologies:
```bash
# Good: Different Hubble masses, resolutions
python run_fire2_mock.py --tags m11b_res2100 m12i_res7100 m09_res30

# Less ideal: Same mass, same resolution
python run_fire2_mock.py --tags m11b_res2100 m11d_res7100 m11h_res7100
```

### 2. Use Enough Images

More projections per galaxy → better statistics:
```bash
# Minimum for testing
--n-per-galaxy 20

# Recommended for real analysis
--n-per-galaxy 50-100

# Maximum (if available)
--n-per-galaxy 100
```

### 3. Adjust Training Parameters

For better embeddings:
```bash
# More training
--epochs 500 --batch-size 512

# Quick test
--epochs 50 --batch-size 128
```

### 4. Check Sample Images First

Always inspect `sample_fire2_galaxies.png` to verify:
- Images loaded correctly
- Morphologies look different across rows
- No obvious artifacts or issues

## Troubleshooting

### Error: "Galaxy directory not found"

**Problem**: Mock images haven't been generated yet.

**Solution**:
```bash
# Generate images for the missing galaxy
python generate_fire2_images.py --tag m11b_res2100 --n-images 50
```

### Error: "Requested 50 images but only 30 available"

**Problem**: Not enough images generated for that galaxy.

**Solution**: Either:
1. Generate more images:
   ```bash
   python generate_fire2_images.py --tag m11b_res2100 --n-images 50
   ```
2. Use fewer images:
   ```bash
   python run_fire2_mock.py --n-per-galaxy 30
   ```

### Poor Classification Performance

**Possible causes**:
1. Galaxies have similar morphologies (inherent limit)
2. Not enough training epochs (increase `--epochs`)
3. Too few images per galaxy (increase `--n-per-galaxy`)
4. Need different preprocessing (modify `preprocess_images_for_byol()`)

**Solutions**:
```bash
# Try longer training
python run_fire2_mock.py --epochs 500

# Try more images
python run_fire2_mock.py --n-per-galaxy 100

# Try different galaxies with more distinct morphologies
python run_fire2_mock.py --tags m09_res30 m12i_res7100
```

### Memory Issues

**Symptoms**: Out-of-memory errors during training.

**Solutions**:
```bash
# Reduce batch size
python run_fire2_mock.py --batch-size 64

# Use fewer images
python run_fire2_mock.py --n-per-galaxy 30

# Use fewer galaxies
python run_fire2_mock.py --tags m11b_res2100 m11d_res7100  # Only 2 instead of 3+
```

## Advanced Usage

### Generate Images and Run Analysis Together

```bash
#!/bin/bash
# Script: run_full_fire2_analysis.sh

TAGS="m11b_res2100 m11d_res7100 m11h_res7100"
N_IMAGES=50

# Generate images for each galaxy
for tag in $TAGS; do
    echo "Generating images for $tag..."
    python generate_fire2_images.py \
        --tag $tag \
        --n-images $N_IMAGES \
        --snapshot 600
done

# Run BYOL analysis
echo "Running BYOL analysis..."
python run_fire2_mock.py \
    --tags $TAGS \
    --n-per-galaxy $N_IMAGES \
    --epochs 300 \
    --batch-size 256

echo "Analysis complete!"
```

### Using Different Snapshots

To compare galaxy evolution:
```bash
# z = 0 (snapshot 600)
python generate_fire2_images.py --tag m11b_res2100 --snapshot 600 --n-images 50

# z = 1 (different snapshot, check snapshot_times.txt)
python generate_fire2_images.py --tag m11b_res2100 --snapshot 400 --n-images 50

# Run analysis on both
python run_fire2_mock.py --tags m11b_res2100_snap600 m11b_res2100_snap400
```

### Combining Multiple Resolutions

Test if resolution affects clustering:
```bash
python run_fire2_mock.py \
    --tags m11b_res2100 m11b_res7100 \
    --n-per-galaxy 50
```

If they cluster separately → resolution matters more than physical properties.
If they cluster together → BYOL is robust to resolution.

## Scientific Applications

### 1. Morphology-Environment Correlation

Test if galaxies from different environments cluster together:
```bash
# Core vs. high-redshift galaxies
python run_fire2_mock.py \
    --tags m11b_res2100 z5m11a \
    --n-per-galaxy 50
```

### 2. Mass Segregation

Test if galaxy mass affects morphology:
```bash
# Different Hubble masses
python run_fire2_mock.py \
    --tags m09_res30 m10v_res30 m11b_res2100 m12i_res7100 \
    --n-per-galaxy 50
```

### 3. Resolution Effects

Quantify how resolution affects learned features:
```bash
# Same galaxy, different resolutions
python run_fire2_mock.py \
    --tags m11b_res2100 m11b_res7100 \
    --n-per-galaxy 50
```

## Citation

If you use this code in your research, please cite:
- FIRE-2 simulations: Hopkins et al. (2018)
- BYOL: Grill et al. (2020)
- Merian Survey pieridae pipeline

## Author

Created for the Merian Survey pieridae pipeline.
Based on `run_simulated.py` by adapting it for FIRE2 mock images.
